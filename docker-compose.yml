services:
  # -------------------------
  # MinIO (S3) for Iceberg
  # -------------------------
  minio:
    image: minio/minio
    container_name: minio
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
      MINIO_DOMAIN: minio
    networks:
      - hybrid_net
        aliases:
          - warehouse.minio
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # MinIO console
    command: ["server", "/data", "--console-address", ":9001"]
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10

  mc:
    image: minio/mc
    container_name: mc
    depends_on:
      - minio
    networks:
      - hybrid_net
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: password
    entrypoint: >
      /bin/sh -c "
      until (/usr/bin/mc alias set minio http://minio:9000 admin password) do
        echo '...waiting for minio...' && sleep 1;
      done;
      /usr/bin/mc rm -r --force minio/warehouse;
      /usr/bin/mc mb minio/warehouse;
      /usr/bin/mc anonymous set public minio/warehouse;
      tail -f /dev/null
      "

  # -------------------------
  # Iceberg REST + Spark
  # -------------------------
  rest:
    image: apache/iceberg-rest-fixture
    container_name: iceberg-rest
    networks:
      - hybrid_net
    ports:
      - "8181:8181"
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: password
      AWS_REGION: us-east-1
      CATALOG_WAREHOUSE: s3://warehouse/
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO
      CATALOG_S3_ENDPOINT: http://minio:9000
    depends_on:
      - minio

  spark-iceberg:
    build: spark/
    image: tabulario/spark-iceberg
    container_name: spark-iceberg
    networks:
      - hybrid_net
    depends_on:
      - rest
      - minio
    volumes:
      - ./warehouse:/home/iceberg/warehouse
      - ./notebooks:/home/iceberg/notebooks/notebooks
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: password
      AWS_REGION: us-east-1
    ports:
      - "8888:8888"
      - "8080:8080"
      - "10000:10000"
      - "10001:10001"

  # -------------------------
  # OpenMetadata DB + Search
  # -------------------------
  mysql:
    image: openmetadata/db:1.10.0
    container_name: openmetadata_mysql
    command: "--sort_buffer_size=10M"
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p$MYSQL_ROOT_PASSWORD"]
      interval: 15s
      timeout: 10s
      retries: 10

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.4
    container_name: openmetadata_elasticsearch
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: -Xms1024m -Xmx1024m
      xpack.security.enabled: "false"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10

  execute-migrate-all:
    image: openmetadata/server:1.10.0
    container_name: execute_migrate_all
    command: "./bootstrap/openmetadata-ops.sh migrate"
    environment:
      SERVER_PORT: 8585
    depends_on:
      - mysql
      - elasticsearch
    networks:
      - hybrid_net

  openmetadata-server:
    image: openmetadata/server:1.10.0
    container_name: openmetadata_server
    restart: always
    environment:
      SERVER_PORT: 8585
      DB_HOST: mysql
      DB_PORT: 3306
      OM_DATABASE: openmetadata_db
      DB_USER: openmetadata_user
      DB_USER_PASSWORD: openmetadata_password
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      SEARCH_TYPE: elasticsearch
      OPENMETADATA_CLUSTER_NAME: openmetadata
    depends_on:
      - mysql
      - elasticsearch
      - execute-migrate-all
    ports:
      - "8585:8585"
      - "8586:8586"
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8586/healthcheck"]

  ingestion:
    image: openmetadata/ingestion:1.10.0
    container_name: openmetadata_ingestion
    depends_on:
      - openmetadata-server
      - mysql
      - elasticsearch
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW_DB: airflow_db
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: airflow_user
      DB_PASSWORD: airflow_pass
    volumes:
      - ingestion-volume-dag-airflow:/opt/airflow/dag_generated_configs
      - ingestion-volume-dags:/opt/airflow/dags
      - ingestion-volume-tmp:/tmp
    ports:
      - "8080:8080"
    networks:
      - hybrid_net
    entrypoint: /bin/bash
    command:
      - "/opt/airflow/ingestion_dependency.sh"

# -------------------------
# Networks and Volumes
# -------------------------
networks:
  hybrid_net:

volumes:
  db-data:
  es-data:
  minio-data:
  ingestion-volume-dag-airflow:
  ingestion-volume-dags:
  ingestion-volume-tmp:
