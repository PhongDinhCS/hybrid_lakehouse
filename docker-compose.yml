version: "3.9"

volumes:
  ingestion-volume-dag-airflow:
  ingestion-volume-dags:
  ingestion-volume-tmp:
  es-data:
  minio-data:
  db-data:
  warehouse:

networks:
  hybrid_net:
    ipam:
      driver: default
      config:
        - subnet: "172.16.240.0/24"

services:
  # -------------------------
  # MinIO for Iceberg storage
  # -------------------------
  minio:
    container_name: minio
    image: minio/minio:RELEASE.2023-08-09T00-14-10Z
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-data:/data
    networks:
      - hybrid_net

  mc:
    container_name: mc
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      sh -c "sleep 5 && mc alias set local http://minio:9000 minio minio123"

  # -------------------------
  # Spark + Iceberg
  # -------------------------
  spark-iceberg:
    container_name: spark-iceberg
    image: tabulario/spark-iceberg
    build: spark/
    depends_on:
      - minio
      - rest
    volumes:
      - ./warehouse:/home/iceberg/warehouse
      - ./notebooks:/home/iceberg/notebooks/notebooks
    networks:
      - hybrid_net

  rest:
    container_name: rest
    image: tabulario/rest:latest
    networks:
      - hybrid_net
  # -------------------------
  # OpenMetadata DB + Search
  # -------------------------
  mysql:
    container_name: openmetadata_mysql
    image: openmetadata/db:1.10.0
    command: "--sort_buffer_size=10M"
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
    expose:
      - 3306
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p$MYSQL_ROOT_PASSWORD"]
      interval: 15s
      timeout: 10s
      retries: 10

  elasticsearch:
    container_name: openmetadata_elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.4
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1024m -Xmx1024m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10

  execute-migrate-all:
    container_name: execute_migrate_all
    image: openmetadata/server:1.10.0
    command: "./bootstrap/openmetadata-ops.sh migrate"
    environment:
      SERVER_PORT: 8585
    depends_on:
      - mysql
      - elasticsearch
    networks:
      - hybrid_net

  openmetadata-server:
    container_name: openmetadata_server
    image: openmetadata/server:1.10.0
    restart: always
    environment:
      SERVER_PORT: 8585
      DB_HOST: mysql
      DB_PORT: 3306
      OM_DATABASE: openmetadata_db
      DB_USER: openmetadata_user
      DB_USER_PASSWORD: openmetadata_password
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      SEARCH_TYPE: elasticsearch
      OPENMETADATA_CLUSTER_NAME: openmetadata
    depends_on:
      - mysql
      - elasticsearch
      - execute-migrate-all
    ports:
      - "8585:8585"
      - "8586:8586"
    networks:
      - hybrid_net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8586/healthcheck"]

  ingestion:
    container_name: openmetadata_ingestion
    image: openmetadata/ingestion:1.10.0
    depends_on:
      - openmetadata-server
      - mysql
      - elasticsearch
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW_DB: airflow_db
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: airflow_user
      DB_PASSWORD: airflow_pass
    volumes:
      - ingestion-volume-dag-airflow:/opt/airflow/dag_generated_configs
      - ingestion-volume-dags:/opt/airflow/dags
      - ingestion-volume-tmp:/tmp
    ports:
      - "8080:8080"
    networks:
      - hybrid_net
    entrypoint: /bin/bash
    command:
      - "/opt/airflow/ingestion_dependency.sh"
